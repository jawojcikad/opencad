import { Vector2D, } from '@opencad/core';
/* ------------------------------------------------------------------ */
/*  Helpers                                                            */
/* ------------------------------------------------------------------ */
/** Rotate a point around an origin by `angleDeg` degrees. */
function rotatePoint(p, origin, angleDeg) {
    const rad = (angleDeg * Math.PI) / 180;
    const cos = Math.cos(rad);
    const sin = Math.sin(rad);
    const dx = p.x - origin.x;
    const dy = p.y - origin.y;
    return new Vector2D(origin.x + dx * cos - dy * sin, origin.y + dx * sin + dy * cos);
}
/* ------------------------------------------------------------------ */
/*  ExcellonGenerator                                                  */
/* ------------------------------------------------------------------ */
/**
 * Generates Excellon NC drill files from a `PCBDocument`.
 *
 * Format specifics:
 * - Metric (METRIC,TZ — trailing‑zero suppression)
 * - Absolute co‑ordinates
 * - 3.3 format (3 integer + 3 fractional digits of mm)
 * - Tool definitions: `T01C0.300` (tool 1, diameter 0.3 mm)
 * - Drill hits: `X12345Y67890`
 */
export class ExcellonGenerator {
    /**
     * Generate a single drill file containing *all* holes (plated and
     * non‑plated are separated by tool groups for convenience, but are
     * in one file).
     */
    generateDrillFile(document) {
        const holes = this.collectHoles(document);
        return this.buildFile(holes);
    }
    /** Generate a drill file containing only plated holes. */
    generatePlatedDrills(document) {
        const holes = this.collectHoles(document).filter((h) => h.plated);
        return this.buildFile(holes, 'PLATED');
    }
    /** Generate a drill file containing only non‑plated holes. */
    generateNonPlatedDrills(document) {
        const holes = this.collectHoles(document).filter((h) => !h.plated);
        return this.buildFile(holes, 'NON_PLATED');
    }
    /* ================================================================ */
    /*  Internal                                                         */
    /* ================================================================ */
    /**
     * Walk through vias and through‑hole pads in the PCB document and
     * collect every drill hole.
     */
    collectHoles(document) {
        const holes = [];
        // Vias
        const vias = document.vias ?? [];
        for (const via of vias) {
            const pos = via.position ?? { x: 0, y: 0 };
            const drill = via.drill ?? 0.3;
            holes.push({ x: pos.x, y: pos.y, diameter: drill, plated: true });
        }
        // Through‑hole pads on footprints
        const footprints = document.footprints ?? [];
        for (const fp of footprints) {
            const fpPos = fp.position ?? { x: 0, y: 0 };
            const fpRot = fp.rotation ?? 0;
            const pads = fp.pads ?? [];
            for (const pad of pads) {
                const drill = pad.drill;
                if (drill === undefined || drill <= 0)
                    continue;
                const padPos = pad.position ?? new Vector2D(0, 0);
                const local = new Vector2D(fpPos.x + padPos.x, fpPos.y + padPos.y);
                const abs = rotatePoint(local, fpPos, fpRot);
                // Through‑hole pads are plated; mounting holes may not be.
                const plated = pad.plated !== false;
                holes.push({ x: abs.x, y: abs.y, diameter: drill, plated });
            }
        }
        return holes;
    }
    /**
     * Group holes by drill diameter so each unique diameter gets its own
     * tool number.
     */
    groupByDiameter(holes) {
        const map = new Map();
        for (const hole of holes) {
            // Round to 3 decimal places (µm precision) to merge close sizes
            const key = Math.round(hole.diameter * 1000) / 1000;
            let group = map.get(key);
            if (!group) {
                group = [];
                map.set(key, group);
            }
            group.push(hole);
        }
        return map;
    }
    /**
     * Build the header section.
     *
     * @param tools Map of tool‑number → diameter (mm)
     */
    formatHeader(tools) {
        const lines = [
            'M48',
            '; Generated by OpenCAD',
            'METRIC,TZ',
            'FMAT,2',
        ];
        for (const [toolNum, diameter] of tools) {
            lines.push(`T${this.padTool(toolNum)}C${diameter.toFixed(3)}`);
        }
        lines.push('%'); // end of header
        return lines.join('\n');
    }
    /**
     * Format a co‑ordinate value (mm) to Excellon 3.3 format.
     * Values like 12.345 → `12345`, -1.5 → `-1500`.
     */
    formatCoord(value) {
        // 3.3 format: multiply by 1000 and truncate to integer
        const intVal = Math.round(value * 1000);
        return intVal.toString();
    }
    /* ================================================================ */
    /*  File construction                                                */
    /* ================================================================ */
    buildFile(holes, label) {
        if (holes.length === 0) {
            return ['M48', '; Generated by OpenCAD', label ? `; ${label}` : '', '%', 'M30'].filter(Boolean).join('\n');
        }
        const grouped = this.groupByDiameter(holes);
        // Assign tool numbers (T01, T02, …)
        const toolMap = new Map(); // diameter → toolNum
        const toolDiameters = new Map(); // toolNum → diameter
        let toolIndex = 1;
        const sortedDiameters = [...grouped.keys()].sort((a, b) => a - b);
        for (const diameter of sortedDiameters) {
            toolMap.set(diameter, toolIndex);
            toolDiameters.set(toolIndex, diameter);
            toolIndex++;
        }
        const lines = [];
        // Header
        lines.push(this.formatHeader(toolDiameters));
        if (label) {
            lines.push(`; ${label}`);
        }
        // Drill hits grouped by tool
        for (const diameter of sortedDiameters) {
            const toolNum = toolMap.get(diameter);
            const group = grouped.get(diameter);
            lines.push(`T${this.padTool(toolNum)}`);
            for (const hole of group) {
                lines.push(`X${this.formatCoord(hole.x)}Y${this.formatCoord(hole.y)}`);
            }
        }
        lines.push('M30'); // end of program
        return lines.join('\n');
    }
    /** Pad tool number to at least 2 digits: 1 → "01". */
    padTool(n) {
        return n.toString().padStart(2, '0');
    }
}
//# sourceMappingURL=excellon-generator.js.map